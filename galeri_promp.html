<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galeri Promp (Approval System)</title>
    <!-- Muat naik Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: "Inter", sans-serif; }
        .gallery-item .delete-btn, .gallery-item .approve-btn {
            opacity: 0; transition: opacity 0.2s ease-in-out;
        }
        .gallery-item:hover .delete-btn, .gallery-item:hover .approve-btn {
            opacity: 1;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Style untuk Nav Button yang aktif */
        .nav-btn.active { background-color: #2563eb; color: white; border-color: #2563eb; }
        .nav-btn { background-color: white; color: #4b5563; border: 1px solid #d1d5db; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-6 md:p-10">

    <main class="max-w-8xl mx-auto">

        <!-- Header -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-center sm:text-left text-gray-800">Galeri Promp</h1>
                <p id="user-welcome" class="text-gray-600 text-center sm:text-left hidden text-sm mt-1"></p>
            </div>
            
            <div class="flex flex-col items-end gap-2 w-full sm:w-auto">
                <button id="login-btn" class="w-full sm:w-auto bg-blue-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200">
                    Log Masuk dengan Google
                </button>

                <!-- User Controls (Disusun Sebaris) -->
                <div id="user-controls" class="hidden flex flex-wrap justify-center sm:justify-end items-center gap-2">
                    
                    <!-- Navigation Tabs (Sebaris dengan +) -->
                    <div class="flex items-center gap-2 mr-2">
                        <button id="nav-gallery" class="nav-btn active px-4 py-2 rounded-lg text-sm font-semibold transition-colors" title="Semua Gambar Approved">
                            Galeri
                        </button>
                        <button id="nav-myprompt" class="nav-btn px-4 py-2 rounded-lg text-sm font-semibold transition-colors" title="Gambar Saya">
                            My Prompt
                        </button>
                        
                        <!-- Tab User Biasa -->
                        <button id="nav-pending" class="nav-btn px-4 py-2 rounded-lg text-sm font-semibold transition-colors hidden" title="Menunggu Approval">
                            Pending <span id="pending-count-user" class="ml-1 bg-red-500 text-white text-[10px] px-1.5 rounded-full hidden">0</span>
                        </button>
                        
                        <!-- Tab Super User -->
                        <button id="nav-request" class="nav-btn px-4 py-2 rounded-lg text-sm font-semibold transition-colors hidden border-yellow-500 text-yellow-700" title="Permintaan Approval">
                            Requested <span id="request-count-admin" class="ml-1 bg-red-600 text-white text-[10px] px-1.5 rounded-full hidden">0</span>
                        </button>
                    </div>

                    <div class="h-8 w-px bg-gray-300 mx-1"></div> <!-- Pemisah Vertical -->

                    <button id="toggle-form-btn" class="w-10 h-10 rounded-full bg-green-600 text-white text-2xl font-bold flex items-center justify-center hover:bg-green-700 transition-colors duration-200 shadow-sm" title="Tambah Promp Baru">
                        +
                    </button>
                    <button id="logout-btn" class="bg-red-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-red-700 transition-colors duration-200 text-sm">
                        Log Keluar
                    </button>
                </div>
            </div>
        </div>

        <!-- Borang Tambah (Hidden) -->
        <div id="add-form-container" class="hidden mb-10">
            <form id="add-form" class="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto border-l-4 border-green-500">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Tambah Promp Baru (Perlu Approval)</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">URL Gambar</label>
                        <input type="text" id="image-url" placeholder="https://..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Promp</label>
                        <textarea id="image-prompt" rows="3" placeholder="Masukkan promp..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                            <select id="category-select" class="w-full p-3 border border-gray-300 rounded-lg">
                                <option value="">-- Pilih --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Atau Baru</label>
                            <input type="text" id="new-category" placeholder="Cth: Anime..." class="w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    <button type="submit" id="submit-button" class="w-full bg-blue-600 text-white font-semibold p-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-400">
                        Hantar untuk Approval
                    </button>
                </div>
            </form>
        </div>

        <!-- Controls Bar (Filter & Admin Action) -->
        <div class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <!-- Tab Kategori -->
            <div class="overflow-x-auto pb-2 hide-scrollbar w-full md:w-auto">
                <div id="category-tabs" class="flex space-x-2 min-w-max px-1 justify-center md:justify-start">
                    <button class="px-4 py-1.5 rounded-full bg-blue-600 text-white text-xs font-semibold">Semua</button>
                </div>
            </div>

            <!-- Butang Admin Approve All (Hanya muncul di tab Request) -->
            <button id="approve-all-btn" class="hidden bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-lg shadow-md text-sm font-bold flex items-center gap-2 animate-pulse">
                <span class="text-lg">✓</span> Approve Semua (<span id="approve-all-count">0</span>)
            </button>
        </div>

        <!-- Tajuk Seksyen Semasa -->
        <h2 id="current-view-title" class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">Galeri Awam</h2>

        <!-- Galeri Container -->
        <div id="gallery-container" class="flex flex-wrap gap-4 justify-center">
            <p id="loading-message" class="text-gray-500 w-full text-center">Memuatkan...</p>
        </div>

    </main>

    <!-- Notification -->
    <div id="notification" class="hidden fixed bottom-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-5 py-3 rounded-lg shadow-lg text-sm font-medium z-50 flex items-center gap-2">
        <span id="notif-msg">Mesej</span>
    </div>

    <!-- Firebase Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, setDoc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCpOw2nHuxHpKfkDxZzAe4nyqXrmhZZbSM",
            authDomain: "galeri-promp-saya.firebaseapp.com",
            projectId: "galeri-promp-saya",
            storageBucket: "galeri-promp-saya.firebasestorage.app",
            messagingSenderId: "963487890074",
            appId: "1:963487890074:web:9140f140b018503380bd23"
        };
        const appId = 'galeri-saya-app';
        const SUPER_USER_EMAIL = 'akmalhamsani@gmail.com';

        // State
        let db, auth, galleryRef, categoriesRef;
        let allItems = [], currentUserId = null, isSuperUser = false;
        let currentView = 'gallery'; // 'gallery', 'myprompt', 'pending', 'request'
        let currentCategory = 'all';

        // DOM Elements
        const els = {
            loginBtn: document.getElementById('login-btn'),
            userControls: document.getElementById('user-controls'),
            userWelcome: document.getElementById('user-welcome'),
            logoutBtn: document.getElementById('logout-btn'),
            toggleFormBtn: document.getElementById('toggle-form-btn'),
            addFormContainer: document.getElementById('add-form-container'),
            addForm: document.getElementById('add-form'),
            submitBtn: document.getElementById('submit-button'),
            gallery: document.getElementById('gallery-container'),
            catTabs: document.getElementById('category-tabs'),
            catSelect: document.getElementById('category-select'),
            viewTitle: document.getElementById('current-view-title'),
            approveAllBtn: document.getElementById('approve-all-btn'),
            approveAllCount: document.getElementById('approve-all-count'),
            navs: {
                gallery: document.getElementById('nav-gallery'),
                myprompt: document.getElementById('nav-myprompt'),
                pending: document.getElementById('nav-pending'),
                request: document.getElementById('nav-request')
            },
            counts: {
                pending: document.getElementById('pending-count-user'),
                request: document.getElementById('request-count-admin')
            }
        };

        // --- MAIN LOGIC ---

        function switchView(viewName) {
            currentView = viewName;
            
            // Update Button Styles
            Object.values(els.navs).forEach(btn => btn.classList.remove('active'));
            if(els.navs[viewName]) els.navs[viewName].classList.add('active');

            // Update Title & Controls
            if (viewName === 'gallery') els.viewTitle.textContent = "Galeri Awam";
            else if (viewName === 'myprompt') els.viewTitle.textContent = "Koleksi Saya";
            else if (viewName === 'pending') els.viewTitle.textContent = "Pending Approval";
            else if (viewName === 'request') els.viewTitle.textContent = "Permintaan Approval (Admin)";

            // Hide/Show Approve All
            if (viewName === 'request' && isSuperUser) els.approveAllBtn.classList.remove('hidden');
            else els.approveAllBtn.classList.add('hidden');

            renderGallery();
        }

        function renderGallery() {
            // 1. Filter by Category first
            let filtered = allItems.filter(item => currentCategory === 'all' || item.category === currentCategory);

            // 2. Filter by View Mode
            let itemsToShow = [];

            if (currentView === 'gallery') {
                // Tunjuk Approved sahaja
                itemsToShow = filtered.filter(item => item.status === 'approved' || !item.status);
            } 
            else if (currentView === 'myprompt') {
                // Tunjuk semua kepunyaan user
                itemsToShow = filtered.filter(item => item.userId === currentUserId);
            } 
            else if (currentView === 'pending') {
                // Tunjuk pending kepunyaan user
                itemsToShow = filtered.filter(item => item.userId === currentUserId && item.status === 'pending');
            } 
            else if (currentView === 'request') {
                // Tunjuk pending dari SEMUA orang (Admin Only)
                itemsToShow = filtered.filter(item => item.status === 'pending');
                // Update approve all count
                els.approveAllCount.textContent = itemsToShow.length;
            }

            els.gallery.innerHTML = '';

            if (itemsToShow.length === 0) {
                els.gallery.innerHTML = `<p class="text-gray-500 w-full text-center py-10">Tiada item dijumpai dalam paparan ini.</p>`;
                return;
            }

            itemsToShow.forEach(item => {
                const card = document.createElement('div');
                card.className = 'gallery-item group bg-white rounded-lg shadow-md cursor-pointer relative flex-grow-0 flex-shrink-0 hover:shadow-xl transition-shadow';
                
                const isOwner = currentUserId && item.userId === currentUserId;
                const status = item.status || 'approved';
                const isPending = status === 'pending';

                // Delete Logic
                const canDelete = isOwner || isSuperUser;
                const deleteBtn = canDelete ? 
                    `<button onclick="window.deleteItem('${item.id}')" class="delete-btn absolute top-2 right-2 z-20 bg-red-600 text-white rounded-full w-7 h-7 flex items-center justify-center shadow-sm hover:bg-red-700" title="Padam">&times;</button>` : '';

                // Approve Logic (Super User Only in Request Tab)
                let approveBtn = '';
                if (isSuperUser && isPending && currentView === 'request') {
                    approveBtn = `<button onclick="window.approveItem('${item.id}')" class="approve-btn absolute top-2 left-2 z-20 bg-green-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-sm hover:bg-green-700 flex items-center gap-1">✓ Approve</button>`;
                }

                // Status Badge (Visible in My Prompt)
                let statusBadge = '';
                if (currentView === 'myprompt' || currentView === 'pending') {
                    const badgeColor = isPending ? 'bg-yellow-500' : 'bg-green-500';
                    const badgeText = isPending ? 'Pending' : 'Approved';
                    statusBadge = `<span class="absolute top-2 left-2 z-10 ${badgeColor} text-white text-[10px] px-2 py-0.5 rounded-full shadow-sm uppercase font-bold tracking-wider opacity-90">${badgeText}</span>`;
                }

                // Copy Function (Clicking card)
                card.onclick = (e) => {
                    if (!e.target.closest('button')) copyToClipboard(item.prompt);
                };

                card.innerHTML = `
                    ${deleteBtn}
                    ${approveBtn}
                    ${statusBadge}
                    <div class="relative rounded-t-lg overflow-hidden">
                        <img src="${item.imageUrl}" class="h-64 md:h-80 w-auto object-cover block min-w-[180px] transition-transform duration-500 group-hover:scale-105" onerror="this.src='https://placehold.co/600x400?text=Error'">
                        <div class="absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-black/80 to-transparent">
                            <p class="text-sm text-white line-clamp-1">${item.prompt}</p>
                        </div>
                        <div class="absolute inset-0 bg-black/80 text-white p-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300 overflow-y-auto z-10">
                            <h4 class="font-bold mb-1 text-xs text-gray-400 uppercase">Promp Penuh:</h4>
                            <p class="text-sm leading-relaxed">${item.prompt}</p>
                        </div>
                    </div>
                    <div class="p-3 bg-white rounded-b-lg border-t border-gray-100 flex justify-between items-center gap-2">
                         <span class="text-[10px] font-bold bg-blue-100 text-blue-600 px-2 py-0.5 rounded uppercase tracking-wide truncate max-w-[100px]">${item.category || 'Umum'}</span>
                         <span class="text-[10px] text-gray-400 truncate">Up By: ${item.userName || 'User'}</span>
                    </div>
                `;
                els.gallery.appendChild(card);
            });
            
            // Spacer for Flex layout
            for(let i=0; i<5; i++) els.gallery.appendChild(document.createElement('div')).className = 'flex-grow h-0 p-0 m-0 opacity-0';
        }

        // --- FIREBASE ACTIONS ---

        window.addItem = async (e) => {
            e.preventDefault();
            if (!currentUserId) return notify("Sila log masuk.", 'error');

            els.submitBtn.disabled = true; els.submitBtn.innerText = "Menghantar...";

            const user = auth.currentUser;
            const newItem = {
                imageUrl: document.getElementById('image-url').value.trim(),
                prompt: document.getElementById('image-prompt').value.trim(),
                category: els.catSelect.value || document.getElementById('new-category').value.trim() || 'Umum',
                timestamp: Date.now(),
                userId: currentUserId,
                userName: (user.displayName || 'User').split(' ')[0],
                status: 'pending' // DEFAULT STATUS
            };

            // Save category if new
            if (document.getElementById('new-category').value.trim()) {
                 setDoc(doc(db, categoriesRef.path, newItem.category), { name: newItem.category }).catch(console.error);
            }

            try {
                await addDoc(galleryRef, newItem);
                els.addForm.reset();
                els.toggleFormBtn.click(); // Close form
                notify("Berjaya dihantar! Menunggu kelulusan admin.");
                switchView('pending'); // Auto switch to pending view
            } catch (err) {
                console.error(err);
                notify("Gagal menghantar.", 'error');
            } finally {
                els.submitBtn.disabled = false; els.submitBtn.innerText = "Hantar untuk Approval";
            }
        };

        window.deleteItem = async (id) => {
            if(!confirm("Padam item ini?")) return;
            try {
                await deleteDoc(doc(db, galleryRef.path, id));
                notify("Item dipadam.");
            } catch(err) { notify("Gagal memadam.", 'error'); }
        };

        window.approveItem = async (id) => {
            try {
                await updateDoc(doc(db, galleryRef.path, id), { status: 'approved' });
                notify("Item diluluskan!");
            } catch(err) { notify("Gagal approve.", 'error'); }
        };

        window.approveAll = async () => {
            const pendingItems = allItems.filter(item => item.status === 'pending');
            if(pendingItems.length === 0) return;
            if(!confirm(`Luluskan semua ${pendingItems.length} item?`)) return;

            const batch = writeBatch(db);
            pendingItems.forEach(item => {
                batch.update(doc(db, galleryRef.path, item.id), { status: 'approved' });
            });

            try {
                await batch.commit();
                notify(`${pendingItems.length} item berjaya diluluskan!`);
            } catch(err) { notify("Gagal approve semua.", 'error'); }
        };

        // --- SETUP & LISTENERS ---

        async function init() {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            galleryRef = collection(db, `/artifacts/${appId}/public/data/gallery`);
            categoriesRef = collection(db, `/artifacts/${appId}/public/data/categories`);

            // 1. Load Categories
            onSnapshot(query(categoriesRef), snap => {
                const cats = [];
                els.catSelect.innerHTML = '<option value="">-- Pilih --</option>';
                els.catTabs.innerHTML = ''; 
                
                snap.forEach(d => cats.push(d.data().name));
                cats.sort();
                
                // Render Tabs
                ['all', ...cats].forEach(cat => {
                    const btn = document.createElement('button');
                    btn.textContent = cat === 'all' ? 'Semua' : cat;
                    btn.className = `px-4 py-1.5 rounded-full text-xs font-semibold transition-colors border ${currentCategory === cat ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-50'}`;
                    btn.onclick = () => {
                        currentCategory = cat;
                        // Re-render tabs for styling
                        Array.from(els.catTabs.children).forEach(b => {
                            b.className = b.textContent === (cat === 'all' ? 'Semua' : cat) 
                                ? 'px-4 py-1.5 rounded-full text-xs font-semibold transition-colors border bg-blue-600 text-white border-blue-600' 
                                : 'px-4 py-1.5 rounded-full text-xs font-semibold transition-colors border bg-white text-gray-600 border-gray-300 hover:bg-gray-50';
                        });
                        renderGallery();
                    };
                    els.catTabs.appendChild(btn);
                    
                    // Render Select
                    if(cat !== 'all') els.catSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
                });
            });

            // 2. Load Gallery Data
            onSnapshot(query(galleryRef), snap => {
                allItems = [];
                snap.forEach(d => allItems.push({id: d.id, ...d.data()}));
                allItems.sort((a, b) => b.timestamp - a.timestamp);
                
                updateCounts();
                renderGallery();
            });

            // 3. Auth Listener
            onAuthStateChanged(auth, user => {
                if (user) {
                    currentUserId = user.uid;
                    isSuperUser = user.email === SUPER_USER_EMAIL;
                    
                    els.userWelcome.textContent = `Hi, ${user.displayName?.split(' ')[0]}`;
                    els.userWelcome.classList.remove('hidden');
                    els.loginBtn.classList.add('hidden');
                    els.userControls.classList.remove('hidden');
                    
                    // Logic Tab Visibility
                    els.navs.myprompt.classList.remove('hidden');
                    els.navs.pending.classList.remove('hidden'); // User ada Pending tab
                    
                    if(isSuperUser) {
                        els.navs.request.classList.remove('hidden'); // Admin ada Request tab
                        els.navs.pending.classList.add('hidden'); // Admin tak perlu tab pending sendiri sangat (optional)
                    } else {
                        els.navs.request.classList.add('hidden');
                    }

                } else {
                    currentUserId = null; isSuperUser = false;
                    els.userWelcome.classList.add('hidden');
                    els.loginBtn.classList.remove('hidden');
                    els.userControls.classList.add('hidden');
                    els.addFormContainer.classList.add('hidden');
                    switchView('gallery'); // Reset ke public view
                }
                renderGallery();
            });
        }

        // Utilities
        function updateCounts() {
            const pendingUser = allItems.filter(i => i.userId === currentUserId && i.status === 'pending').length;
            const pendingAll = allItems.filter(i => i.status === 'pending').length;
            
            if(pendingUser > 0) { els.counts.pending.textContent = pendingUser; els.counts.pending.classList.remove('hidden'); } 
            else els.counts.pending.classList.add('hidden');

            if(pendingAll > 0) { els.counts.request.textContent = pendingAll; els.counts.request.classList.remove('hidden'); }
            else els.counts.request.classList.add('hidden');
        }

        function notify(msg, type='success') {
            const notif = document.getElementById('notification');
            const txt = document.getElementById('notif-msg');
            txt.textContent = msg;
            notif.className = `fixed bottom-5 left-1/2 -translate-x-1/2 px-5 py-3 rounded-lg shadow-lg text-sm font-medium z-50 flex items-center gap-2 ${type === 'error' ? 'bg-red-600 text-white' : 'bg-gray-800 text-white'}`;
            notif.classList.remove('hidden');
            setTimeout(() => notif.classList.add('hidden'), 3000);
        }

        function copyToClipboard(text) {
            const t = document.createElement('textarea'); t.value = text; document.body.appendChild(t); t.select();
            try { document.execCommand('copy'); notify('Promp disalin!'); } catch (e) {}
            document.body.removeChild(t);
        }

        // Bind Events
        els.addForm.onsubmit = window.addItem;
        els.loginBtn.onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
        els.logoutBtn.onclick = () => signOut(auth);
        els.toggleFormBtn.onclick = () => {
            els.addFormContainer.classList.toggle('hidden');
            els.toggleFormBtn.innerHTML = els.addFormContainer.classList.contains('hidden') ? '+' : '&times;';
            els.toggleFormBtn.classList.toggle('bg-green-600'); els.toggleFormBtn.classList.toggle('bg-red-600');
        };
        els.approveAllBtn.onclick = window.approveAll;

        // Tab Clicks
        Object.keys(els.navs).forEach(key => {
            if(els.navs[key]) els.navs[key].onclick = () => switchView(key);
        });

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
