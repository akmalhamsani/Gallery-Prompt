<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galeri Promp (Cloud)</title>
    <!-- Muat naik Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Tetapkan fon Inter sebagai lalai */
        body {
            font-family: "Inter", sans-serif;
        }
        /* Sembunyikan 'x' delete, tunjuk bila hover */
        .gallery-item .delete-btn {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .gallery-item:hover .delete-btn {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-6 md:p-10">

    <main class="max-w-6xl mx-auto">
        <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-2">
            Galeri Promp Saya
        </h1>
        <p class="text-center text-gray-500 mb-8 text-sm">Disimpan di Cloud</p>

        <!-- Borang untuk menambah item baru -->
        <form id="add-form" class="bg-white p-6 rounded-lg shadow-md mb-10 max-w-2xl mx-auto">
            <div class="space-y-4">
                <div>
                    <label for="image-url" class="block text-sm font-medium text-gray-700 mb-1">URL Gambar</label>
                    <input type="text" id="image-url" placeholder="https://..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="image-prompt" class="block text-sm font-medium text-gray-700 mb-1">Promp</label>
                    <textarea id="image-prompt" rows="3" placeholder="Terangkan imej atau masukkan promp anda di sini..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required></textarea>
                </div>
                <button type="submit" id="submit-button" class="w-full bg-blue-600 text-white font-semibold p-3 rounded-lg hover:bg-blue-700 transition-colors duration-200 disabled:bg-gray-400">
                    Tambah ke Galeri
                </button>
            </div>
        </form>

        <!-- Bekas untuk galeri -->
        <div id="gallery-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <!-- Mesej memuat naik -->
            <p id="loading-message" class="text-gray-500 col-span-full text-center">Memuatkan galeri anda...</p>
        </div>
    </main>

    <!-- Notifikasi "Tersalin" -->
    <div id="notification" class="hidden fixed bottom-5 left-1/2 -translate-x-1/2 bg-green-600 text-white px-5 py-2 rounded-lg shadow-lg text-sm font-medium">
        Promp disalin ke papan klip!
    </div>

    <!-- Skrip Firebase -->
    <script type="module">
        // Import fungsi Firebase yang diperlukan
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            query, 
            doc, 
            deleteDoc,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Dapatkan elemen DOM
        const form = document.getElementById('add-form');
        const submitButton = document.getElementById('submit-button');
        const galleryContainer = document.getElementById('gallery-container');
        const imageUrlInput = document.getElementById('image-url');
        const imagePromptInput = document.getElementById('image-prompt');
        const notification = document.getElementById('notification');
        const loadingMessage = document.getElementById('loading-message');

        // Pembolehubah global Firebase
        let db, auth, userId, galleryCollectionRef;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Fungsi untuk memaparkan galeri
        function renderGallery(items) {
            // Kosongkan bekas galeri
            galleryContainer.innerHTML = '';

            // Jika tiada item, tunjukkan mesej
            if (items.length === 0) {
                galleryContainer.innerHTML = `
                    <p class="text-gray-500 col-span-full text-center">Galeri anda kosong. Sila tambah beberapa gambar.</p>
                `;
                return;
            }

            // Loop melalui setiap item dan cipta kad HTML
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'gallery-item bg-white rounded-lg shadow-md overflow-hidden cursor-pointer transition-transform transform hover:scale-105 relative';
                // Simpan promp dalam 'data-prompt' untuk akses mudah
                card.dataset.prompt = item.prompt;
                card.dataset.id = item.id; // Simpan ID dokumen Firestore

                card.innerHTML = `
                    <button data-id="${item.id}" class="delete-btn absolute top-2 right-2 z-10 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold text-sm leading-none hover:bg-red-700" title="Padam">&times;</button>
                    <img src="${item.imageUrl}" alt="Gambar Galeri" class="w-full h-48 object-cover" onerror="this.src='https_placehold.co/600x400/cccccc/444444?text=Imej+Rosak'; this.alt='Imej Gagal Dimuat'">
                    <div class="p-4">
                        <p class="text-sm text-gray-700 line-clamp-3">${item.prompt}</p>
                    </div>
                `;
                galleryContainer.appendChild(card);
            });
        }

        // Fungsi untuk memuatkan item dari Firestore secara real-time
        function loadGalleryFromFirestore() {
            if (!galleryCollectionRef) return;

            // Cipta 'query' untuk mendengar data
            const q = query(galleryCollectionRef);

            // Guna 'onSnapshot' untuk data real-time
            onSnapshot(q, (snapshot) => {
                let items = [];
                snapshot.forEach((doc) => {
                    // Masukkan data DAN ID dokumen
                    items.push({ id: doc.id, ...doc.data() });
                });

                // Susun item: yang terbaru dahulu (berdasarkan timestamp)
                items.sort((a, b) => b.timestamp - a.timestamp);

                // Papar galeri yang dikemas kini
                renderGallery(items);
            }, (error) => {
                console.error("Error listening to gallery: ", error);
                loadingMessage.innerText = "Gagal memuatkan galeri.";
            });
        }

        // Fungsi untuk menambah item baru ke Firestore
        async function addItem(event) {
            event.preventDefault(); // Halang borang daripada submit
            
            if (!galleryCollectionRef) {
                console.error("Database tidak bersedia.");
                return;
            }

            const imageUrl = imageUrlInput.value.trim();
            const prompt = imagePromptInput.value.trim();

            if (!imageUrl || !prompt) {
                console.error("URL dan Promp diperlukan");
                return;
            }

            // Lumpuhkan butang semasa menghantar
            submitButton.disabled = true;
            submitButton.innerText = "Menambah...";

            const newItem = {
                imageUrl: imageUrl,
                prompt: prompt,
                timestamp: Date.now() // Simpan timestamp untuk menyusun
            };

            try {
                // Tambah dokumen baru ke 'collection'
                await addDoc(galleryCollectionRef, newItem);
                // onSnapshot akan mengemas kini UI secara automatik
                form.reset(); // Kosongkan borang
            } catch (err) {
                console.error("Error menambah dokumen: ", err);
                showNotification("Gagal menambah item.");
            } finally {
                // Aktifkan semula butang
                submitButton.disabled = false;
                submitButton.innerText = "Tambah ke Galeri";
            }
        }
        
        // Fungsi untuk memadam item dari Firestore
        async function deleteItem(id) {
            if (!galleryCollectionRef || !id) return;

            try {
                // Rujuk kepada dokumen spesifik menggunakan IDnya
                const docRef = doc(db, galleryCollectionRef.path, id);
                // Padam dokumen
                await deleteDoc(docRef);
                // onSnapshot akan mengemas kini UI secara automatik
                showNotification("Item dipadam.");
            } catch (err) {
                console.error("Error memadam dokumen: ", err);
                showNotification("Gagal memadam item.");
            }
        }

        // Fungsi untuk menyalin teks ke papan klip
        function copyToClipboard(text) {
            const tempTextarea = document.createElement('textarea');
            tempTextarea.value = text;
            document.body.appendChild(tempTextarea);
            tempTextarea.select();
            
            try {
                document.execCommand('copy');
                showNotification('Promp disalin ke papan klip!');
            } catch (err) {
                console.error('Gagal menyalin:', err);
                showNotification('Gagal menyalin promp.');
            }
            
            document.body.removeChild(tempTextarea);
        }

        // Fungsi untuk menunjukkan notifikasi
        function showNotification(message) {
            notification.textContent = message;
            notification.classList.remove('hidden');
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 2000);
        }

        // Fungsi untuk mengendalikan klik pada galeri (event delegation)
        function handleGalleryClick(event) {
            // Semak jika butang padam diklik
            const deleteButton = event.target.closest('.delete-btn');
            if (deleteButton) {
                const id = deleteButton.dataset.id;
                // Tanya pengesahan (guna modal yang lebih baik dalam app sebenar)
                // Oleh kerana `confirm` disekat, kita padam terus
                deleteItem(id);
                return; // Berhenti di sini, jangan salin promp
            }

            // Semak jika kad itu sendiri diklik
            const card = event.target.closest('.gallery-item');
            if (card && card.dataset.prompt) {
                copyToClipboard(card.dataset.prompt);
            }
        }
        
        // Fungsi utama untuk memulakan Firebase
        async function initializeFirebaseAndAuth() {
            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Aktifkan log untuk penyahpepijatan
                setLogLevel('Debug');

                // Dengar perubahan status auth
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // Pengguna telah log masuk
                        userId = user.uid;
                        console.log("Pengguna disahkan:", userId);
                        
                        // Tetapkan laluan koleksi (peribadi kepada pengguna)
                        galleryCollectionRef = collection(db, `/artifacts/${appId}/users/${userId}/gallery`);
                        
                        // Muatkan galeri
                        loadGalleryFromFirestore();
                    } else {
                        // Pengguna log keluar
                        console.log("Pengguna log keluar.");
                        userId = null;
                        galleryContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">Sila log masuk untuk melihat galeri anda.</p>';
                    }
                });

                // Log masuk pengguna
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Error memulakan Firebase:", error);
                loadingMessage.innerText = "Gagal menyambung ke servis.";
            }
        }

        // Tambah Event Listeners
        document.addEventListener('DOMContentLoaded', initializeFirebaseAndAuth);
        form.addEventListener('submit', addItem);
        galleryContainer.addEventListener('click', handleGalleryClick);

    </script>
</body>
</html>
